package components

import (
	"htmx-gemini-chat/models"
	"strconv"
)

templ menuBarButton() {
	<template x-if="!$store.data.menuOpen">
		<button
			class="appearance-none outline-none z-10 absolute top-2 left-2 rounded cursor-pointer p-1 bg-cyan-600 text-slate-200 transition duration-300 hover:opacity-80 focus:ring-2 focus:ring-cyan-600 focus:ring-offset-2 focus:ring-offset-cyan-50"
			x-bind:style="!$store.data.menuOpen && {viewTransitionName:'menu-icon-button'}"
			x-on:click="$store.data.openMenu()"
		>
			<svg
				xmlns="http://www.w3.org/2000/svg"
				viewBox="0 0 24 24"
				fill="currentColor"
				class="size-6"
				x-bind:style="!$store.data.menuOpen && {viewTransitionName:'menu-icon'}"
			>
				<path fill-rule="evenodd" d="M3 6.75A.75.75 0 0 1 3.75 6h16.5a.75.75 0 0 1 0 1.5H3.75A.75.75 0 0 1 3 6.75ZM3 12a.75.75 0 0 1 .75-.75h16.5a.75.75 0 0 1 0 1.5H3.75A.75.75 0 0 1 3 12Zm0 5.25a.75.75 0 0 1 .75-.75h16.5a.75.75 0 0 1 0 1.5H3.75a.75.75 0 0 1-.75-.75Z" clip-rule="evenodd"></path>
			</svg>
		</button>
	</template>
}

templ menu(sessions []models.ChatSession) {
	<div
		class="absolute top-0 left-0 h-dvh w-dvw bg-gray-900/50 flex items-start gap-2"
		x-trap="$store.data.menuOpen"
		x-show="$store.data.menuOpen"
		style="view-transition-name:menu"
	>
		<aside
			class="p-1 animate-menu-open w-10/12 h-dvh flex flex-col bg-gray-900 border-r border-slate-200  md:w-1/2 lg:w-1/3 xl:w-1/4"
		>
			@newChatButton()
			<ul
				id="ul_menu"
				class="appearance-none outline-none w-full h-full mt-5 scroll-smooth scrollbar-thin scrollbar-track-gray-300 scrollbar-thumb-lime-500 "
			>
				for _,session:= range sessions {
					@MenuItem(session, false)
				}
			</ul>
		</aside>
		<button
			class="appearance-none outline-none animate-menu-open rounded cursor-pointer p-1 mt-2 bg-slate-200 text-red-600 transition duration-300 opacity-80 hover:opacity-100 focus:opacity-100 focus:ring-1 focus:ring-slate-200 focus:ring-offset-2 focus:ring-offset-red-600"
			x-on:click="$store.data.closeMenu()"
			x-bind:style="$store.data.menuOpen && {viewTransitionName:'menu-icon-button'}"
		>
			<svg
				xmlns="http://www.w3.org/2000/svg"
				viewBox="0 0 24 24"
				fill="currentColor"
				class="size-6"
				x-bind:style="$store.data.menuOpen && {viewTransitionName:'menu-icon'}"
			>
				<path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 0 1 1.06 0L12 10.94l5.47-5.47a.75.75 0 1 1 1.06 1.06L13.06 12l5.47 5.47a.75.75 0 1 1-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 0 1-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd"></path>
			</svg>
		</button>
	</div>
}

templ MenuItem(session models.ChatSession, animate bool) {
	{{ url := "/?id=" + strconv.Itoa(session.Id) }}
	{{ animationClass := "animate-scale-y" }}
	if !animate {
		{{ animationClass = "" }}
	}
	<li
		id={ "li_" + strconv.Itoa(session.Id) }
		class={ "cursor-pointer py-2 px-4  w-full transition duration-300 hover:opacity-80 flex gap-1",animationClass }
	>
		<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6 rotate-y-180">
			<path fill-rule="evenodd" d="M12 2.25c-2.429 0-4.817.178-7.152.521C2.87 3.061 1.5 4.795 1.5 6.741v6.018c0 1.946 1.37 3.68 3.348 3.97.877.129 1.761.234 2.652.316V21a.75.75 0 0 0 1.28.53l4.184-4.183a.39.39 0 0 1 .266-.112c2.006-.05 3.982-.22 5.922-.506 1.978-.29 3.348-2.023 3.348-3.97V6.741c0-1.947-1.37-3.68-3.348-3.97A49.145 49.145 0 0 0 12 2.25ZM8.25 8.625a1.125 1.125 0 1 0 0 2.25 1.125 1.125 0 0 0 0-2.25Zm2.625 1.125a1.125 1.125 0 1 1 2.25 0 1.125 1.125 0 0 1-2.25 0Zm4.875-1.125a1.125 1.125 0 1 0 0 2.25 1.125 1.125 0 0 0 0-2.25Z" clip-rule="evenodd"></path>
		</svg>
		<a
			class="apperance-none outline-none w-full flex-1 truncate rounded transition duration-300 focus:underline focus:underline-offset-4"
			href={ templ.SafeURL(url) }
			hx-get={ string(templ.SafeURL(url)) }
			hx-boost="true"
			hx-swap="outerHTML transition:true"
			hx-target="body"
			hx-trigger="FETCH_FULL_PAGE_EVENT"
			hx-push-url="true"
			x-on:click="$store.data.sendFullPageFetchEvent($event,'FETCH_FULL_PAGE_EVENT')"
			style={ "view-transition-name:title-" + strconv.Itoa(session.Id) }
		>
			{ session.Title }
		</a>
	</li>
}

templ newChatButton() {
	<button
		hx-post="/new"
		hx-target="#ul_menu"
		hx-swap="beforeend transition:true"
		hx-trigger="ADD_NEW_CHAT_SESSION_EVENT"
		class="apperance-none outline-none cursor-pointer w-11/12 h-10 mx-auto bg-slate-200 rounded py-1 px-3 mt-4 shadow text-slate-600 transition duration-300 focus:ring-2 focus:ring-slate-200 focus:ring-offset-2 focus:ring-offset-slate-600 hover:opacity-80 disabled:cursor-not-allowed"
		x-on:click="$store.data.checkAndSetAddNewProcessing($event,'ADD_NEW_CHAT_SESSION_EVENT')"
		x-bind:disabled="$store.data.addNewChatSessionProcessing"
	>
		<template x-if="!$store.data.addNewChatSessionProcessing">
			<span style="view-transition-name:new-chat-button">New Chat</span>
		</template>
		<template x-if="$store.data.addNewChatSessionProcessing">
			<div class="w-full flex justify-center items-center gap-1 flex-1" style="view-transition-name:new-chat-button">
				<span class="h-1.5 w-1.5 bg-slate-600 rounded-full animate-loader-one"></span>
				<span class="h-1.5 w-1.5 bg-slate-600 rounded-full animate-loader-two"></span>
			</div>
		</template>
	</button>
}
