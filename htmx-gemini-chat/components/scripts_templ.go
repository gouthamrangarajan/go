// Code generated by templ - DO NOT EDIT.

// templ: version: v0.3.887
package components

//lint:file-ignore SA4006 This context is only used if a nested component is present.

import "github.com/a-h/templ"
import templruntime "github.com/a-h/templ/runtime"

var onceHandle = templ.NewOnceHandle()

func bodyScript() templ.Component {
	return templruntime.GeneratedTemplate(func(templ_7745c5c3_Input templruntime.GeneratedComponentInput) (templ_7745c5c3_Err error) {
		templ_7745c5c3_W, ctx := templ_7745c5c3_Input.Writer, templ_7745c5c3_Input.Context
		if templ_7745c5c3_CtxErr := ctx.Err(); templ_7745c5c3_CtxErr != nil {
			return templ_7745c5c3_CtxErr
		}
		templ_7745c5c3_Buffer, templ_7745c5c3_IsBuffer := templruntime.GetBuffer(templ_7745c5c3_W)
		if !templ_7745c5c3_IsBuffer {
			defer func() {
				templ_7745c5c3_BufErr := templruntime.ReleaseBuffer(templ_7745c5c3_Buffer)
				if templ_7745c5c3_Err == nil {
					templ_7745c5c3_Err = templ_7745c5c3_BufErr
				}
			}()
		}
		ctx = templ.InitializeContext(ctx)
		templ_7745c5c3_Var1 := templ.GetChildren(ctx)
		if templ_7745c5c3_Var1 == nil {
			templ_7745c5c3_Var1 = templ.NopComponent
		}
		ctx = templ.ClearChildren(ctx)
		templ_7745c5c3_Var2 := templruntime.GeneratedTemplate(func(templ_7745c5c3_Input templruntime.GeneratedComponentInput) (templ_7745c5c3_Err error) {
			templ_7745c5c3_W, ctx := templ_7745c5c3_Input.Writer, templ_7745c5c3_Input.Context
			templ_7745c5c3_Buffer, templ_7745c5c3_IsBuffer := templruntime.GetBuffer(templ_7745c5c3_W)
			if !templ_7745c5c3_IsBuffer {
				defer func() {
					templ_7745c5c3_BufErr := templruntime.ReleaseBuffer(templ_7745c5c3_Buffer)
					if templ_7745c5c3_Err == nil {
						templ_7745c5c3_Err = templ_7745c5c3_BufErr
					}
				}()
			}
			ctx = templ.InitializeContext(ctx)
			templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 1, "<script type=\"text/javascript\">\n            var ABORT_CONTROLLER=new AbortController();//Global variable     \n            var TIMEOUT;\n            function setErrorMessage(message){\n                Alpine.store('data').errorMessage=message;\n                if(TIMEOUT){\n                    clearTimeout(TIMEOUT);\n                }\n                TIMEOUT=setTimeout(()=>{\n                    if(document.startViewTransition){\n                        document.startViewTransition(()=>{\n                            Alpine.store('data').errorMessage=\"\";\n                        });\n                    }else{\n                         Alpine.store('data').errorMessage=\"\";\n                    }\n                },3000)\n            }              \n            document.body.addEventListener('htmx:afterSwap', function(event) {\t\n                if(Alpine.store('data').addNewChatSessionProcessing){\n                    Alpine.store('data').addNewChatSessionProcessing=false;\n                    const newChatSessionId=document.getElementById(\"chatSessionId\").value;\n                    window.history.replaceState({},document.title,window.location.origin+\"/\"+newChatSessionId);                     \n                } else if(Alpine.store('data').fullPageFetchProcessing){\n                    Alpine.store('data').fullPageFetchProcessing=false;\n                }\n                else{   \n                    const chatSessionId=document.getElementById(\"chatSessionId\").value;\n                    const chatSessionIdParsed=parseInt(chatSessionId);                    \n                     if(!window.location.pathname.endsWith(\"/\"+chatSessionId)){\n                        if(isNaN(chatSessionIdParsed) || chatSessionIdParsed==0){\n                            window.history.replaceState({},document.title,window.location.origin);                     \n                        }\n                        else {\n                            window.history.replaceState({},document.title,window.location.origin+\"/\"+chatSessionId);                     \n                        }  \n                     }\n                }            \t\t\t\t\t\n            }, { signal: ABORT_CONTROLLER.signal });    \n            document.body.addEventListener('htmx:afterRequest', function(event) {\t\n                if(event.detail.failed){\n                    setErrorMessage('Error! Please try again later'); \n                    if(Alpine.store('data').addNewChatSessionProcessing){\n                       Alpine.store('data').addNewChatSessionProcessing=false;                                                      \n                    }\t\n                    if(Alpine.store('data').fullPageFetchProcessing){\n                       Alpine.store('data').fullPageFetchProcessing=false;                                                      \n                    }\t                    \n                }\n                if(Alpine.store('data').deleteChatSessionProcessing){\n                    Alpine.store('data').deleteChatSessionProcessing=false;                                                      \n                }\t\n            }, { signal: ABORT_CONTROLLER.signal });\n            document.body.addEventListener('htmx:confirm', function(evt) {                \n                const msg=evt.target.getAttribute('hx-confirm');\n                if(msg){\n                  evt.preventDefault();\n                  const confirmationResult=window.confirm(msg);\n                  if(confirmationResult){\n                    evt.detail.issueRequest(true)\n                  }\n                  else if(Alpine.store('data').deleteChatSessionProcessing){\n                    Alpine.store('data').deleteChatSessionProcessing=false;                                                      \n                  }\n                }\n            }, { signal: ABORT_CONTROLLER.signal });\n            document.addEventListener('alpine:init', () => {                \n                Alpine.store('data',{\n                    addNewChatSessionProcessing:false,\n                    deleteChatSessionProcessing:false,\n                    fullPageFetchProcessing:false,\n                    promptProcessing:false,\n                    promptMessageId:-1,\n                    menuOpen:false,\n                    errorMessage:\"\",\n                    openMenu(){\n                        if(document.startViewTransition){\n                            document.startViewTransition(()=>{\n                                this.menuOpen=true;\n                            });\n                        }\n                        else{\n                            this.menuOpen=true;\n                        }\n                    },\n                    closeMenu(){\n                        if(document.startViewTransition){\n                            document.startViewTransition(()=>{\n                                this.menuOpen=false;\n                            });\n                        }\n                        else{\n                            this.menuOpen=false;\n                        }\n                    },\n                    sendFullPageFetchEvent(ev,eventNameToDispatch){\n                        ev.preventDefault();                        \n                        this.fullPageFetchProcessing=true;\n                        this.closeMenu();\n                        if(ABORT_CONTROLLER){\n                            ABORT_CONTROLLER.abort();\n                        }   \n                        if(eventNameToDispatch){        \n                            ev.currentTarget.dispatchEvent(new Event(eventNameToDispatch));\n                        }                        \n                        \n                    },\n                    checkAndSetAddNewProcessing(ev,eventNameToDispatch){\n                        ev.preventDefault();\n                        if(!this.addNewChatSessionProcessing){\n                            this.addNewChatSessionProcessing=true;\n                            if(eventNameToDispatch){\n                                ev.currentTarget.dispatchEvent(new Event(eventNameToDispatch));\n                            }\n                        }\n                    },\n                    checkAndSetDeleteProcessing(ev,eventNameToDispatch){\n                        ev.preventDefault();\n                        if(!this.deleteChatSessionProcessing){\n                            this.deleteChatSessionProcessing=true;\n                            if(eventNameToDispatch){\n                                ev.currentTarget.dispatchEvent(new Event(eventNameToDispatch));\n                            }\n                        }\n                    },\n                    \n                });\n                Alpine.data('chatInput',()=>({\n                    prompt:'',\n                    imgBase64:\"\",\n                    fileName:\"\",                \n                    setProcessing(val){\n                        if(document.startViewTransition){\n                            document.startViewTransition(()=>{\n                                this.$store.data.promptProcessing=val;                                \n                            })\n                        }\n                        else{\n                            this.$store.data.promptProcessing=val;                            \n                        }\n                    },                                        \n                    fileInputChanged(ev){\n                        const fl=ev.currentTarget.files[0];\n                        const reader = new FileReader();\n                        reader.addEventListener(\"load\",() => {\n                            if (typeof reader.result == \"string\") {\n                                if(reader.result.startsWith(\"data:image/\")){\n                                    this.imgBase64=reader.result;\n                                    this.fileName=fl.name;\n                                }else{\n                                    setErrorMessage('Please select a valid image file')\n                                }\n                            }\n                        },{ signal: ABORT_CONTROLLER.signal });\n                        if (fl.size <= 1024 * 1024) {//1 mb\n                            reader.readAsDataURL(fl);\n                        }else{\n                            setErrorMessage('Image size exceeds the limit of 1 MB');                                 \n                        }\n                    },\n                    clearFileInput(){         \n                        if(document.startViewTransition){\n                            document.startViewTransition(()=>{\n                                this.imgBase64='';\n                                this.fileName=''; \n                            });\n                        }               \n                        else{\n                            this.imgBase64='';\n                            this.fileName=''; \n                        }                        \n                        this.$refs.imageInput.value=''\n                    },\n                    submitMessage(ev,idToAppendData){\n                        if(!ev.shiftKey && this.prompt.trim()!='' && !this.processing){\n                            this.setProcessing(true);\n                            const fm=new FormData();\n                            fm.append(\"prompt\",this.prompt);\n                            fm.append(\"imgBase64\",this.imgBase64)\n                            fm.append(\"chatSessionId\",document.getElementById(\"chatSessionId\").value);                                                        \n                            let decodedValueMerged =\"\";\n                            fetch('/send',{\n                                body:fm,\n                                method:\"POST\",\n                                signal:ABORT_CONTROLLER.signal\n                            }).then(resp=>{\n                                if(!resp.ok){\n                                    this.setProcessing(false);\n                                    setErrorMessage('Error! Please try again later');     \n                                    return;\n                                }\n                                this.prompt='';         \n                                // document.getElementById(idToAppendData).scrollTop = document.getElementById(idToAppendData).scrollHeight +40 ;                                                       \n                                const reader = resp.body.getReader();\n                                const processChunk = async () => {\n                                    const { done, value } = await reader.read();\n                                    if(done){//streaming end\n                                        this.setProcessing(false);\n                                        this.$store.data.promptMessageId=\"\";\n                                        decodedValueMerged=\"\";\n                                        return;\n                                    }\n                                    let decodedValue = new TextDecoder().decode(value);                                                                         \n                                    if(decodedValue.includes(\"data:END\")){//streaming end\n                                        this.setProcessing(false);\n                                        this.$store.data.promptMessageId=-1;\n                                        decodedValueMerged=\"\";                                        \n                                        // document.getElementById(idToAppendData).scrollTop = document.getElementById(idToAppendData).scrollHeight +40 ;                       \n                                        return;\n                                    }\n                                    else if(decodedValue.includes(\"data:ERROR\")){//error in gemini api\n                                        this.setProcessing(false);\n                                        this.$store.data.promptMessageId=-1;\n                                        decodedValueMerged=\"\";                                        \n                                        setErrorMessage('Error! Please try again later');     \n                                        return;\n                                    }\n                                    else if(decodedValue.startsWith(\"<div class\")){ //streamed output is a new user message item or new gemini message item\n                                        this.$store.data.promptMessageId = createNewMessageUIAndGetMessageId(idToAppendData,decodedValue);                                                                                 \n                                        decodedValueMerged=\"\";\n                                        if(this.imgBase64!=\"\"){//streamed output is user message and its based on image input so prepend Img\n                                            prependImageToUserMessage(this.$store.data.promptMessageId,this.imgBase64)\n                                            this.clearFileInput();\n                                        }       \n                                        document.getElementById(idToAppendData).scrollTop = document.getElementById(idToAppendData).scrollHeight +40;                                 \n                                    }\n                                    else if(decodedValue.startsWith(\"<li\") && decodedValue.includes('id=\"li_')){ //streamed output is new menu item or existing menu title change \n                                        upsertMenuUIWithMenuItem(decodedValue);  \n                                    }\n                                    else if(decodedValue.startsWith(\"<input\") && decodedValue.includes(\"chatSessionId\")){ //chat session id intput\n                                        document.getElementById('chatSessionId').outerHTML=decodedValue;                                        \n                                    }\n                                    else{ //streamed output is gemini message that needs to be appended to existing message \n                                        decodedValueMerged += decodedValue;                                        \n                                        document.getElementById('message_'+this.$store.data.promptMessageId).innerHTML = decodedValueMerged;   \n                                        // document.getElementById(idToAppendData).scrollTop = document.getElementById(idToAppendData).scrollHeight;                                                            \n                                    }\n                                    processChunk();\n                                }\n                                processChunk()\n                            }).catch(err=>{\n                                console.log(err);\n                                this.setProcessing(false);\n                                setErrorMessage('Error! Please try again later');     \n                            });                            \n                        }\n                    },\n                   \n                }));                               \n            },{signal:ABORT_CONTROLLER.signal});             \n            function createNewMessageUIAndGetMessageId(idToAppendHTML,messageUI){                \n                const divEl=document.createElement(\"div\");\n                document.getElementById(idToAppendHTML).appendChild(divEl);\n                divEl.outerHTML=messageUI;                                \n                const strtIdx=messageUI.indexOf(\"message_\");\n                if (strtIdx==-1){                   \n                    return -1;\n                }\n                const messageId=messageUI.substring(strtIdx+\"message_\".length,messageUI.indexOf('\"',strtIdx));                \n                return messageId;\n            }\n            function prependImageToUserMessage(messageId,imgBase64){\n               const elToPrependImg= document.getElementById(\"message_\"+messageId).parentElement.parentElement;\n               const imgEl=document.createElement(\"img\")\n               imgEl.classList.add(\"w-full\", \"h-full\")\n               imgEl.src=imgBase64        \n               elToPrependImg.prepend(imgEl);              \n            }\n            function upsertMenuUIWithMenuItem(menuItemUI){\n                const strtIdx=menuItemUI.indexOf(\"li_\");\n                const elId=menuItemUI.substring(strtIdx,menuItemUI.indexOf('\"',strtIdx));\n                const el=document.getElementById(elId);\n                if(el){//title change\n                    if(document.startViewTransition){\n                        document.startViewTransition(()=>{\n                            el.outerHTML=menuItemUI;\n                        });\n                    }else{\n                        el.outerHTML=menuItemUI;\n                    }\n                }else{//new menu item\n                    const liEl=document.createElement(\"li\");\n                    document.getElementById('ul_menu').appendChild(liEl);\n                    liEl.outerHTML=menuItemUI;\n                    liEl.classList.remove('animate-scale-y');                                        \n                }   \n                htmx.process(document.getElementById(elId));\n            }           \n        </script>")
			if templ_7745c5c3_Err != nil {
				return templ_7745c5c3_Err
			}
			return nil
		})
		templ_7745c5c3_Err = onceHandle.Once().Render(templ.WithChildren(ctx, templ_7745c5c3_Var2), templ_7745c5c3_Buffer)
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		return nil
	})
}

var _ = templruntime.GeneratedTemplate
